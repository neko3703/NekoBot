<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Poll</title>
     <link
      rel="shortcut icon"
      href="./images/ニキータ・パリク.png"
      type="image/png"
    />
    <link rel="stylesheet" href="assets/css/bulma.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/tippy.js@6/animations/scale.css"
    />

    <!---Meta Property 2------->
    <meta property="og:site_name" content="ニキータ・パリク" />
    <meta property="og:title" content="ニキータ・パリク" />
    <meta property="og:url" content="https://nekocode.in/" />
    <meta property="og:type" content="website" />
    <meta
      property="og:description"
      content="Enhance your Discord server with ニキータ・パリク – the ultimate multi-purpose bot. From moderation to entertainment, enjoy seamless integration and customizable features."
    />
    <meta property="og:color" content="0xfaafba" />
    <!--Change The Description-->
    <meta property="og:image" content="images/ニキータ・パリク.png" />
    <!--Change The Above Description & Other Meta Stuff-->

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
      integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <script src="assets/js/jquery-3.6.0.js"></script>
</head>
<body>
<!--     <h1>Thank you for sharing your response.</h1> -->
    <h2 id="message"></h1>
<!--     <p id="message"></p> -->

    <script>
        // This function extracts the query parameters from the URL
        function getQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const response = urlParams.get('response');  // Extract the 'response' parameter
            if (response) {
                // Display the response on the page
                if (response == "yes") {
                    document.getElementById('message').textContent = "Thank you for providing a positive feedback!";
                } else if (response == "no") {
                    document.getElementById('message').textContent = "We're sorry to hear that. We'll work to improve!";// "We see that you are not satisfied with the resolution. We take this seriously and are working to improve our services.";
                }
                // document.getElementById('message').textContent = "Your response is: " + response;

                // Send the response to GitHub for storage
                storeResponse(response);
            }
        }

        // Function to store the response in GitHub
        function storeResponse(response) {
            const githubToken = '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';  // Replace with your personal GitHub token
            const owner = 'neko3703';  // Replace with your GitHub username
            const repo = 'NekoBot';  // Replace with your repository name
            const filePath = 'responses.json';  // Path to your responses JSON file
            // const issueTitle = `Poll Response: ${response}`;
            // const issueBody = `Response: ${response} submitted at ${new Date().toLocaleString()}`;

            // Fetch the existing responses
            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3.raw'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Fetched data:', data); // Log the fetched data
                console.log('Raw content:', data.content); // Log the raw content

                let currentResponses;
        
                try {
                    currentResponses = JSON.parse(atob(data.content));
                } catch (e) {
                    console.error('Failed to decode content:', e);
                    currentResponses = { responses: [] }; // Fallback to a new object if decoding fails
                }
                
                const currentResponses = JSON.parse(atob(data.content));
                currentResponses.responses.push(response);

                // Update the file with the new responses
                const updatedContent = btoa(JSON.stringify(currentResponses));
                return fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'Updated responses',
                        content: updatedContent,
                        sha: data.sha  // Include the SHA of the existing file
                    })
                });
            })
            .then(response => {
                if (response.ok) {
                    console.log('Response stored successfully!');
                } else {
                    console.error('Error updating file:', response);
                }
            })
            .catch(error => console.error('Error:', error));
        }


        // Call the getQueryParams function when the page loads
        window.onload = getQueryParams;
    </script>
</body>
</html>
